<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>LiveKit Test Join</title>
    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
  </head>
  <body>
    <h2>LiveKit Test Join</h2>
    <button id="joinBtn" onclick="joinRoom()">Join Room</button>
    <button id="leaveBtn" onclick="leaveRoom()" style="display:none;">Leave Room</button>
    <div id="status">Click "Join Room" to start</div>
    <video id="localVideo" autoplay playsinline muted style="width: 300px; height: 200px; border: 1px solid #ccc;"></video>
    <video id="remoteVideo" autoplay playsinline style="width: 300px; height: 200px; border: 1px solid #ccc;"></video>
    <script>
      const url = "wss://YOUR_LIVEKIT_URL_HERE"; // Replace with your actual LiveKit URL
      const token = "YOUR_LIVEKIT_TOKEN_HERE"; // Replace with your actual JWT token
      
      let room = null;

      // Check permissions before joining room
      async function checkPermissions() {
        try {
          document.getElementById('status').textContent = 'Checking camera and microphone permissions...';
          
          // Test camera permission
          const cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
          cameraStream.getTracks().forEach(track => track.stop());
          
          // Test microphone permission  
          const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          micStream.getTracks().forEach(track => track.stop());
          
          document.getElementById('status').textContent = 'Camera and microphone permissions confirmed';
          return true;
          
        } catch (error) {
          console.error("❌ Permission check failed:", error);
          
          if (error.name === 'NotAllowedError') {
            document.getElementById('status').textContent = '❌ Camera and microphone permissions are required. Please allow both camera and microphone access in your browser settings and refresh the page.';
          } else if (error.name === 'NotFoundError') {
            document.getElementById('status').textContent = '❌ No camera or microphone found. Please connect a camera and microphone and try again.';
          } else if (error.name === 'NotReadableError') {
            document.getElementById('status').textContent = '❌ Camera or microphone is being used by another application. Please close other applications and try again.';
          } else {
            document.getElementById('status').textContent = `❌ Permission check failed: ${error.message}`;
          }
          
          return false;
        }
      }

      async function joinRoom() {
        try {
          document.getElementById('status').textContent = 'Connecting...';
          document.getElementById('joinBtn').style.display = 'none';
          
          // Check permissions first
          const permissionsOk = await checkPermissions();
          if (!permissionsOk) {
            document.getElementById('joinBtn').style.display = 'inline';
            return;
          }
          
          room = new LivekitClient.Room();
          
          // Add event listeners
          room.on('participantConnected', p => {
            console.log('Participant connected:', p.identity);
            document.getElementById('status').textContent = `Participant connected: ${p.identity}`;
          });
          
          room.on('participantDisconnected', p => {
            console.log('Participant disconnected:', p.identity);
            document.getElementById('status').textContent = `Participant disconnected: ${p.identity}`;
          });
          
          room.on('trackSubscribed', (track, pub, participant) => {
            console.log('Track subscribed:', track.kind, participant.identity);
            if (track.kind === 'video') {
              document.getElementById('remoteVideo').srcObject = new MediaStream([track.mediaStreamTrack]);
            }
          });
          
          room.on('trackUnsubscribed', (track, pub, participant) => {
            console.log('Track unsubscribed:', track.kind, participant.identity);
          });
          
          room.on('connected', () => {
            console.log('Connected to room');
            document.getElementById('status').textContent = 'Connected to room';
            document.getElementById('leaveBtn').style.display = 'inline';
          });
          
          room.on('disconnected', () => {
            console.log('Disconnected from room');
            document.getElementById('status').textContent = 'Disconnected from room';
            document.getElementById('joinBtn').style.display = 'inline';
            document.getElementById('leaveBtn').style.display = 'none';
          });

          // Connect to room
          await room.connect(url, token);
          
          // Get user media with user gesture
          const tracks = await LivekitClient.createLocalTracks({ 
            audio: true, 
            video: { 
              width: 640, 
              height: 480 
            } 
          });
          
          // Publish tracks
          tracks.forEach(track => {
            room.localParticipant.publishTrack(track);
          });

          // Set local video
          const localVideo = document.getElementById('localVideo');
          localVideo.srcObject = new MediaStream(tracks.map(t => t.mediaStreamTrack));
          
          document.getElementById('status').textContent = 'Connected and publishing!';
          
        } catch (error) {
          console.error('Error joining room:', error);
          document.getElementById('status').textContent = `Error: ${error.message}`;
          document.getElementById('joinBtn').style.display = 'inline';
        }
      }

      async function leaveRoom() {
        if (room) {
          await room.disconnect();
          room = null;
        }
      }
    </script>
  </body>
</html>
