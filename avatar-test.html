<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>LiveKit + Anam.ai Avatar Test</title>
    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-container h3 {
            margin-top: 0;
            color: #333;
        }
        video {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            background: #000;
        }
        .controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .avatar-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üé≠ LiveKit + Anam.ai Avatar Integration</h1>
    
    <div class="controls">
        <button id="joinBtn" onclick="joinRoom()">Join Room</button>
        <button id="leaveBtn" onclick="leaveRoom()" style="display:none;">Leave Room</button>
        <button id="startAvatarBtn" onclick="startAvatar()" style="display:none;">Start Avatar</button>
        <button id="stopAvatarBtn" onclick="stopAvatar()" style="display:none;">Stop Avatar</button>
    </div>

    <div class="avatar-info">
        <h3>ü§ñ Anam.ai Avatar Configuration</h3>
        <p><strong>Avatar ID:</strong> <span id="avatarId">demo-avatar-001</span></p>
        <p><strong>Avatar Name:</strong> <span id="avatarName">AI Assistant</span></p>
        <p><strong>Status:</strong> <span id="avatarStatus">Ready to start</span></p>
    </div>

    <div class="container">
        <div class="video-container">
            <h3>üìπ Your Camera</h3>
            <video id="localVideo" autoplay playsinline muted></video>
        </div>
        <div class="video-container">
            <h3>üé≠ Anam.ai Avatar</h3>
            <video id="avatarVideo" autoplay playsinline></video>
        </div>
    </div>

    <div class="video-container">
        <h3>üë• Remote Participants</h3>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="status" class="status">Click "Join Room" to start the LiveKit session</div>

    <script>
        // LiveKit Configuration
        const url = "wss://YOUR_LIVEKIT_URL_HERE"; // Replace with your actual LiveKit URL
        const token = "YOUR_LIVEKIT_TOKEN_HERE"; // Replace with your actual JWT token
        
        // Anam.ai Configuration - Update these with your actual values
        const ANAM_CONFIG = {
            avatarId: "aea2cf13-5e40-4c0f-bd4e-b597b1c0acb4", // Your actual avatar ID
            avatarName: "Dave", // Your actual avatar name
            apiKey: "YOUR_ANAM_API_KEY", // Replace with your actual Anam API key
            baseUrl: "https://api.anam.ai"
        };

        let room = null;
        let avatarSession = null;
        let isAvatarActive = false;

        // Update status display
        function updateStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            if (isError) {
                statusEl.innerHTML += `<div class="error">${logMessage}</div>`;
            } else {
                statusEl.innerHTML += `${logMessage}\n`;
            }
            statusEl.scrollTop = statusEl.scrollHeight;
        }

        // Update avatar status
        function updateAvatarStatus(status) {
            document.getElementById('avatarStatus').textContent = status;
        }

        // Check permissions before joining room
        async function checkPermissions() {
            try {
                updateStatus('üîç Checking camera and microphone permissions...');
                
                // Test camera permission
                const cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraStream.getTracks().forEach(track => track.stop());
                
                // Test microphone permission  
                const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                micStream.getTracks().forEach(track => track.stop());
                
                updateStatus('‚úÖ Camera and microphone permissions confirmed');
                return true;
                
            } catch (error) {
                console.error("‚ùå Permission check failed:", error);
                
                if (error.name === 'NotAllowedError') {
                    updateStatus('‚ùå Camera and microphone permissions are required for the avatar to work.', true);
                    updateStatus('üí° Please allow both camera and microphone access in your browser settings and refresh the page.', true);
                } else if (error.name === 'NotFoundError') {
                    updateStatus('‚ùå No camera or microphone found. Please connect a camera and microphone and try again.', true);
                } else if (error.name === 'NotReadableError') {
                    updateStatus('‚ùå Camera or microphone is being used by another application. Please close other applications and try again.', true);
                } else {
                    updateStatus(`‚ùå Permission check failed: ${error.message}`, true);
                }
                
                return false;
            }
        }

        // Join LiveKit room
        async function joinRoom() {
            try {
                updateStatus('üîÑ Connecting to LiveKit room...');
                document.getElementById('joinBtn').style.display = 'none';
                
                // Check permissions first
                const permissionsOk = await checkPermissions();
                if (!permissionsOk) {
                    document.getElementById('joinBtn').style.display = 'inline';
                    return;
                }
                
                room = new LivekitClient.Room();
                
                // Set up event listeners
                setupRoomEventListeners();
                
                // Connect to room
                await room.connect(url, token);
                
                // Get user media
                const tracks = await LivekitClient.createLocalTracks({ 
                    audio: true, 
                    video: { width: 640, height: 480 } 
                });
                
                // Publish tracks
                tracks.forEach(track => {
                    room.localParticipant.publishTrack(track);
                });

                // Set local video
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = new MediaStream(tracks.map(t => t.mediaStreamTrack));
                
                document.getElementById('leaveBtn').style.display = 'inline';
                document.getElementById('startAvatarBtn').style.display = 'inline';
                updateStatus('‚úÖ Connected to LiveKit room successfully!');
                
            } catch (error) {
                console.error('Error joining room:', error);
                updateStatus(`‚ùå Error joining room: ${error.message}`, true);
                document.getElementById('joinBtn').style.display = 'inline';
            }
        }

        // Set up room event listeners
        function setupRoomEventListeners() {
            room.on('participantConnected', participant => {
                updateStatus(`üë§ Participant connected: ${participant.identity}`);
            });
            
            room.on('participantDisconnected', participant => {
                updateStatus(`üë§ Participant disconnected: ${participant.identity}`);
            });
            
            room.on('trackSubscribed', (track, publication, participant) => {
                updateStatus(`üìπ Track subscribed: ${track.kind} from ${participant.identity}`);
                
                if (track.kind === 'video') {
                    const remoteVideo = document.getElementById('remoteVideo');
                    remoteVideo.srcObject = new MediaStream([track.mediaStreamTrack]);
                }
            });
            
            room.on('trackUnsubscribed', (track, publication, participant) => {
                updateStatus(`üìπ Track unsubscribed: ${track.kind} from ${participant.identity}`);
            });
            
            room.on('connected', () => {
                updateStatus('üîó Room connection established');
            });
            
            room.on('disconnected', () => {
                updateStatus('üîå Disconnected from room');
                document.getElementById('joinBtn').style.display = 'inline';
                document.getElementById('leaveBtn').style.display = 'none';
                document.getElementById('startAvatarBtn').style.display = 'none';
                document.getElementById('stopAvatarBtn').style.display = 'none';
            });
        }

        // Start Anam.ai Avatar
        async function startAvatar() {
            try {
                updateStatus('ü§ñ Starting Anam.ai avatar...');
                updateAvatarStatus('Starting...');
                
                // This is a placeholder for the actual Anam.ai integration
                // In a real implementation, you would:
                // 1. Initialize the Anam.ai SDK
                // 2. Create an avatar session
                // 3. Connect it to the LiveKit room
                
                // Simulate avatar startup
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // For demo purposes, we'll simulate the avatar video
                const avatarVideo = document.getElementById('avatarVideo');
                avatarVideo.style.background = 'linear-gradient(45deg, #667eea 0%, #764ba2 100%)';
                avatarVideo.style.display = 'flex';
                avatarVideo.style.alignItems = 'center';
                avatarVideo.style.justifyContent = 'center';
                avatarVideo.style.color = 'white';
                avatarVideo.style.fontSize = '24px';
                avatarVideo.textContent = 'üé≠ Anam Avatar';
                
                isAvatarActive = true;
                document.getElementById('startAvatarBtn').style.display = 'none';
                document.getElementById('stopAvatarBtn').style.display = 'inline';
                updateAvatarStatus('Active');
                updateStatus('‚úÖ Anam.ai avatar started successfully!');
                
            } catch (error) {
                console.error('Error starting avatar:', error);
                updateStatus(`‚ùå Error starting avatar: ${error.message}`, true);
                updateAvatarStatus('Error');
            }
        }

        // Stop Anam.ai Avatar
        async function stopAvatar() {
            try {
                updateStatus('üõë Stopping Anam.ai avatar...');
                updateAvatarStatus('Stopping...');
                
                // Simulate avatar shutdown
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const avatarVideo = document.getElementById('avatarVideo');
                avatarVideo.style.background = '#000';
                avatarVideo.textContent = '';
                
                isAvatarActive = false;
                document.getElementById('startAvatarBtn').style.display = 'inline';
                document.getElementById('stopAvatarBtn').style.display = 'none';
                updateAvatarStatus('Stopped');
                updateStatus('‚úÖ Anam.ai avatar stopped');
                
            } catch (error) {
                console.error('Error stopping avatar:', error);
                updateStatus(`‚ùå Error stopping avatar: ${error.message}`, true);
            }
        }

        // Leave LiveKit room
        async function leaveRoom() {
            if (room) {
                if (isAvatarActive) {
                    await stopAvatar();
                }
                await room.disconnect();
                room = null;
            }
        }

        // Initialize the page
        updateStatus('üöÄ LiveKit + Anam.ai Avatar Integration Ready');
        updateStatus('üìã Instructions:');
        updateStatus('1. Click "Join Room" to connect to LiveKit');
        updateStatus('2. Allow camera/microphone permissions');
        updateStatus('3. Click "Start Avatar" to activate Anam.ai avatar');
        updateStatus('4. Open multiple tabs to test multi-participant functionality');
    </script>
</body>
</html>
