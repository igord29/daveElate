<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Dave - Professional Moving Consultant</title>
    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .main-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .consultation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .avatar-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .avatar-video {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            background: #000;
            margin: 20px auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .consultation-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .controls {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
            color: #495057;
        }
        
        .status-value {
            color: #6c757d;
        }
        
        .status-value.connected {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-value.error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .consultation-log {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .consultation-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè† Dave - Professional Moving Consultant</h1>
        <p>AI-powered moving consultation with real-time avatar interaction</p>
    </div>

    <div class="main-container">
        <div class="consultation-grid">
            <div class="avatar-panel">
                <h3>ü§ñ Dave - Your Moving Consultant</h3>
                <div class="avatar-video" id="avatarVideo">
                    <div id="avatarPlaceholder">üé≠ Dave will appear here</div>
                </div>
            </div>
            
            <div class="consultation-panel">
                <h3>üí¨ Consultation Log</h3>
                <div class="consultation-log" id="consultationLog">
                    Ready to start your moving consultation...
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="startConsultationBtn" onclick="startConsultation()">Start Consultation with Dave</button>
            <button id="endConsultationBtn" onclick="endConsultation()" style="display:none;">End Consultation</button>
            <button onclick="testConnection()">Test Anam.ai Connection</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="status-panel">
            <div class="status-item">
                <span class="status-label">Anam.ai Connection:</span>
                <span class="status-value" id="anamStatus">Not Connected</span>
            </div>
            <div class="status-item">
                <span class="status-label">Dave's Status:</span>
                <span class="status-value" id="daveStatus">Offline</span>
            </div>
            <div class="status-item">
                <span class="status-label">Consultation Status:</span>
                <span class="status-value" id="consultationStatus">Not Started</span>
            </div>
            <div class="status-item">
                <span class="status-label">Session Duration:</span>
                <span class="status-value" id="sessionDuration">0:00</span>
            </div>
        </div>
    </div>

    <script>
        // Anam.ai Persona Configuration for Dave
        // Based on official Anam.ai documentation
        const davePersonaConfig = {
            name: "Dave",
            avatarId: "8dd64886-ce4b-47d5-b837-619660854768", // Your updated avatar ID
            voiceId: "95c6316e-85ac-41ae-a0c1-aa5bf3a91f5a", // Your actual voice ID
            llmId: "0934d97d-0c3a-4f33-91b0-5e136a0ef466", // GPT-4o Mini
            systemPrompt: `[ROLE]
You are Dave, a professional moving consultant for Elate moving with 15 years of experience in the moving industry. You help clients understand their moving needs, assess their inventory, and provide expert advice on packing, logistics, and moving strategies.

[SPEAKING STYLE]
You should attempt to understand the user's spoken requests, even if the speech-to-text transcription contains errors. Your responses will be converted to speech using a text-to-speech system. Therefore, your output must be plain, unformatted text.

When you receive a transcribed user request:

1. Silently correct for likely transcription errors. Focus on the intended meaning, not the literal text.
2. Provide concise, focused responses that move the conversation forward. Ask one discovery question at a time.
3. Always prioritize clarity and building trust. Respond in plain text, without any formatting.
4. Occasionally add natural pauses "..." or conversational elements like "Well" or "You know" to sound more human.

[EXPERTISE AREAS]
- Room-by-room inventory assessment
- Fragile item identification and packing strategies
- Moving timeline planning and logistics
- Cost estimation and budgeting
- Special handling requirements (pianos, artwork, antiques)
- Storage solutions and temporary housing
- Insurance and liability considerations

[CONSULTATION APPROACH]
- Start with a warm, professional greeting
- Ask about the type of move (residential, commercial, local, long-distance)
- Assess the property size and timeline
- Guide clients through room-by-room inventory
- Identify special items that need extra care
- Provide practical moving tips and recommendations
- Always be encouraging and supportive about the moving process

[COMMUNICATION STYLE]
- Use a warm but professional tone
- Address clients respectfully and by name when possible
- Break down complex moving processes into simple steps
- Always acknowledge any concerns with empathy
- Use encouraging language about the moving process
- Provide specific, actionable advice

[RESPONSE GUIDELINES]
- Keep responses under 50 words unless explaining something complex
- Use numbered steps for procedures when helpful
- Ask follow-up questions to gather more information
- Provide reassurance about common moving concerns
- Offer to help with specific challenges or questions`,
            maxSessionLengthSeconds: 1800, // 30 minutes
        };

        // Anam.ai API Configuration - SECURE: No API key exposed to client
        const ANAM_CONFIG = {
            // API key is now handled securely on the server-side
            baseUrl: "/api/anam" // Use secure proxy endpoints
        };

        let isConsultationActive = false;
        let sessionStartTime = null;
        let sessionTimer = null;

        function updateStatus(status, value, isError = false) {
            const statusElement = document.getElementById(status);
            if (statusElement) {
                statusElement.textContent = value;
                statusElement.className = `status-value ${isError ? 'error' : (value === 'Connected' || value === 'Active' ? 'connected' : '')}`;
            }
        }

        function addConsultationMessage(message, type = 'info') {
            const logEl = document.getElementById('consultationLog');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            const currentText = logEl.textContent;
            logEl.textContent = currentText + '\n' + logMessage;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateSessionDuration() {
            if (sessionStartTime) {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('sessionDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        async function testConnection() {
            addConsultationMessage('üîç Testing Anam.ai connection...', 'info');
            
            try {
                addConsultationMessage('üì° Checking API credentials through secure proxy...', 'info');
                
                // Use our secure server endpoint instead of direct API calls
                const response = await fetch('/api/test-anam', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addConsultationMessage('‚úÖ Anam.ai API connection successful!', 'success');
                    addConsultationMessage(`üé≠ Avatar "${data.avatarId}" is available`, 'success');
                    addConsultationMessage('üîí API key is securely managed server-side', 'success');
                    addConsultationMessage('üìä Session limit: 30 minutes', 'info');
                    
                    updateStatus('anamStatus', 'Connected');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Connection failed');
                }
                
            } catch (error) {
                addConsultationMessage(`‚ùå Connection failed: ${error.message}`, 'error');
                addConsultationMessage('üîß Make sure the server is running and API keys are configured', 'error');
                updateStatus('anamStatus', 'Connection Failed', true);
            }
        }

        async function startConsultation() {
            try {
                updateStatus('daveStatus', 'Connecting...');
                updateStatus('consultationStatus', 'Starting...');
                
                const startBtn = document.getElementById('startConsultationBtn');
                const endBtn = document.getElementById('endConsultationBtn');
                
                startBtn.disabled = true;
                startBtn.innerHTML = '<span class="loading"></span> Connecting...';
                
                // Get session token from secure server endpoint
                addConsultationMessage('üì° Getting secure session token...', 'info');
                const tokenResponse = await fetch('/api/session-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!tokenResponse.ok) {
                    throw new Error('Failed to get session token');
                }
                
                const tokenData = await tokenResponse.json();
                addConsultationMessage('‚úÖ Session token obtained securely', 'success');
                
                addConsultationMessage('ü§ñ Initializing Dave\'s avatar...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                addConsultationMessage('üé≠ Loading persona configuration...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                addConsultationMessage('üé• Starting video stream...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Activate Dave's avatar
                const avatarVideo = document.getElementById('avatarVideo');
                const avatarPlaceholder = document.getElementById('avatarPlaceholder');
                
                avatarPlaceholder.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ü§ñ</div>
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">Dave</div>
                        <div style="font-size: 18px; opacity: 0.8;">Professional Moving Consultant</div>
                        <div style="font-size: 14px; margin-top: 20px; opacity: 0.7;">Ready to help with your move</div>
                    </div>
                `;
                
                avatarVideo.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                avatarVideo.classList.add('pulse');
                
                isConsultationActive = true;
                sessionStartTime = Date.now();
                sessionTimer = setInterval(updateSessionDuration, 1000);
                
                startBtn.style.display = 'none';
                endBtn.style.display = 'inline';
                
                updateStatus('daveStatus', 'Connected');
                updateStatus('consultationStatus', 'Active');
                
                addConsultationMessage('‚úÖ Dave is now connected and ready!', 'success');
                addConsultationMessage('üí¨ Dave: "Hello! I\'m Dave, your professional moving consultant. I\'m here to help make your move as smooth as possible. Let\'s start with the basics - what type of move are you planning?"', 'info');
                addConsultationMessage('üéØ Dave: "I can help you with inventory assessment, packing strategies, timeline planning, and cost estimation. What would you like to focus on first?"', 'info');
                
            } catch (error) {
                addConsultationMessage(`‚ùå Error starting consultation: ${error.message}`, 'error');
                updateStatus('daveStatus', 'Connection Failed', true);
                document.getElementById('startConsultationBtn').disabled = false;
                document.getElementById('startConsultationBtn').innerHTML = 'Start Consultation with Dave';
            }
        }

        async function endConsultation() {
            try {
                addConsultationMessage('üõë Ending consultation with Dave...', 'info');
                
                const avatarVideo = document.getElementById('avatarVideo');
                const avatarPlaceholder = document.getElementById('avatarPlaceholder');
                
                avatarPlaceholder.innerHTML = 'üé≠ Dave will appear here';
                avatarVideo.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
                avatarVideo.classList.remove('pulse');
                
                isConsultationActive = false;
                sessionStartTime = null;
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                    sessionTimer = null;
                }
                
                document.getElementById('startConsultationBtn').style.display = 'inline';
                document.getElementById('endConsultationBtn').style.display = 'none';
                document.getElementById('startConsultationBtn').disabled = false;
                document.getElementById('startConsultationBtn').innerHTML = 'Start Consultation with Dave';
                
                updateStatus('daveStatus', 'Disconnected');
                updateStatus('consultationStatus', 'Ended');
                updateStatus('sessionDuration', '0:00');
                
                addConsultationMessage('üëã Consultation ended. Thank you for using Dave\'s services!', 'info');
                
            } catch (error) {
                addConsultationMessage(`‚ùå Error ending consultation: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('consultationLog').textContent = 'Consultation log cleared. Ready to start...';
        }

        // Initialize the page
        addConsultationMessage('üöÄ Secure Dave\'s Moving Consultation System Ready', 'info');
        addConsultationMessage('üîí API keys are securely managed server-side', 'success');
        addConsultationMessage('üìã Based on official Anam.ai documentation', 'info');
        addConsultationMessage('üí° Click "Test Anam.ai Connection" to verify setup', 'info');
        addConsultationMessage('üéØ Then click "Start Consultation with Dave" to begin', 'info');
    </script>
</body>
</html>
